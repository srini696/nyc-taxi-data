{
    "stateMachineArn": "arn:aws:states:us-east-1:473157801752:stateMachine:taxi-nyc-pipeline",
    "name": "taxi-nyc-pipeline",
    "status": "ACTIVE",
    "definition": "{\"Comment\":\"Optimized MDM Pipeline - Batch Processing with Steward Approval\",\"StartAt\":\"InitializePipeline\",\"States\":{\"InitializePipeline\":{\"Type\":\"Pass\",\"Comment\":\"Initialize pipeline parameters\",\"Parameters\":{\"pipelineRunId.$\":\"States.Format('mdm-run-{}', $$.Execution.Name)\",\"triggeredBy\":\"step-functions\",\"executionStartTime.$\":\"$$.Execution.StartTime\",\"executionArn.$\":\"$$.Execution.Id\",\"batchSize\":100000,\"autoApproveThreshold\":0.85,\"totalProcessed\":0,\"totalAutoApproved\":0,\"totalNeedingReview\":0},\"Next\":\"CreateAuditRecord\"},\"CreateAuditRecord\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Create initial audit record\",\"Parameters\":{\"FunctionName\":\"mdm-update-audit-history\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"triggeredBy.$\":\"$.triggeredBy\",\"executionArn.$\":\"$.executionArn\",\"eventType\":\"start\"}},\"ResultPath\":\"$.auditResult\",\"Next\":\"RunRawToValidatedGlue\"},\"RunRawToValidatedGlue\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::glue:startJobRun.sync\",\"Parameters\":{\"JobName\":\"yellow_raw_to_validated\"},\"ResultPath\":\"$.rawToValidatedResult\",\"Retry\":[{\"ErrorEquals\":[\"States.ALL\"],\"IntervalSeconds\":30,\"MaxAttempts\":2,\"BackoffRate\":2}],\"Catch\":[{\"ErrorEquals\":[\"States.ALL\"],\"ResultPath\":\"$.error\",\"Next\":\"PipelineFailed\"}],\"Next\":\"RunValidatedToCuratedGlue\"},\"RunValidatedToCuratedGlue\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::glue:startJobRun.sync\",\"Parameters\":{\"JobName\":\"yellow_validated_to_curated\"},\"ResultPath\":\"$.validatedToCuratedResult\",\"Retry\":[{\"ErrorEquals\":[\"States.ALL\"],\"IntervalSeconds\":30,\"MaxAttempts\":2,\"BackoffRate\":2}],\"Catch\":[{\"ErrorEquals\":[\"States.ALL\"],\"ResultPath\":\"$.error\",\"Next\":\"PipelineFailed\"}],\"Next\":\"ProcessBatch\"},\"ProcessBatch\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Process batch: fetch trips, match entities, create PROPOSED records\",\"Parameters\":{\"FunctionName\":\"mdm-process-pipeline\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"batchSize.$\":\"$.batchSize\",\"autoApproveThreshold.$\":\"$.autoApproveThreshold\"}},\"ResultSelector\":{\"status.$\":\"$.Payload.status\",\"stats.$\":\"$.Payload.stats\",\"summary.$\":\"$.Payload.summary\"},\"ResultPath\":\"$.batchResult\",\"Retry\":[{\"ErrorEquals\":[\"States.TaskFailed\"],\"IntervalSeconds\":10,\"MaxAttempts\":2,\"BackoffRate\":2}],\"Next\":\"CheckBatchStatus\"},\"CheckBatchStatus\":{\"Type\":\"Choice\",\"Choices\":[{\"Variable\":\"$.batchResult.status\",\"StringEquals\":\"NO_DATA\",\"Next\":\"CheckForPendingApprovals\"},{\"Variable\":\"$.batchResult.status\",\"StringEquals\":\"FAILED\",\"Next\":\"PipelineFailed\"}],\"Default\":\"UpdateBatchCounters\"},\"UpdateBatchCounters\":{\"Type\":\"Pass\",\"Comment\":\"Accumulate statistics across batches\",\"Parameters\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"triggeredBy.$\":\"$.triggeredBy\",\"executionStartTime.$\":\"$.executionStartTime\",\"batchSize.$\":\"$.batchSize\",\"autoApproveThreshold.$\":\"$.autoApproveThreshold\",\"totalProcessed.$\":\"States.MathAdd($.totalProcessed, $.batchResult.stats.tripsProcessed)\",\"totalAutoApproved.$\":\"States.MathAdd($.totalAutoApproved, $.batchResult.stats.autoApproved)\",\"totalNeedingReview.$\":\"States.MathAdd($.totalNeedingReview, $.batchResult.stats.needsStewardReview)\",\"rawToValidatedResult.$\":\"$.rawToValidatedResult\",\"validatedToCuratedResult.$\":\"$.validatedToCuratedResult\",\"lastBatchProcessed.$\":\"$.batchResult.stats.tripsProcessed\"},\"Next\":\"ShouldProcessMoreBatches\"},\"ShouldProcessMoreBatches\":{\"Type\":\"Choice\",\"Comment\":\"Continue processing if last batch had data\",\"Choices\":[{\"Variable\":\"$.lastBatchProcessed\",\"NumericGreaterThan\":0,\"Next\":\"ProcessBatch\"}],\"Default\":\"UpdateAuditAfterBatches\"},\"UpdateAuditAfterBatches\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Update audit with batch processing statistics\",\"Parameters\":{\"FunctionName\":\"mdm-update-audit-history\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"eventType\":\"batch_update\",\"totalProcessed.$\":\"$.totalProcessed\",\"totalAutoApproved.$\":\"$.totalAutoApproved\",\"totalNeedingReview.$\":\"$.totalNeedingReview\"}},\"ResultPath\":\"$.auditResult\",\"Next\":\"CheckForPendingApprovals\"},\"CheckForPendingApprovals\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Check if there are PROPOSED records needing steward approval\",\"Parameters\":{\"FunctionName\":\"mdm-check-proposal-status\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\"}},\"ResultSelector\":{\"hasProposed.$\":\"$.Payload.hasProposed\",\"counts.$\":\"$.Payload.counts\",\"totalProposed.$\":\"$.Payload.totalProposed\"},\"ResultPath\":\"$.proposedCheck\",\"Next\":\"HasProposedRecords\"},\"HasProposedRecords\":{\"Type\":\"Choice\",\"Choices\":[{\"Variable\":\"$.proposedCheck.hasProposed\",\"BooleanEquals\":true,\"Next\":\"SendStewardNotification\"}],\"Default\":\"PipelineSuccess\"},\"SendStewardNotification\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::sns:publish\",\"Parameters\":{\"TopicArn\":\"arn:aws:sns:us-east-1:473157801752:mdm-steward-alerts\",\"Subject\":\"MDM Review Required - Action Needed\",\"Message.$\":\"States.Format('Pipeline Run: {}\\n\\n=== STATISTICS ===\\nTotal Trips Processed: {}\\nAuto-Approved Matches: {}\\nNeed Steward Review: {}\\n\\n=== PROPOSED RECORDS ===\\nVendors: {}\\nZones: {}\\nRate Codes: {}\\n\\nPlease review and approve records in the MDM system.\\n\\nThe pipeline will check for approvals every 5 minutes.\\n\\nExecution: {}', $.pipelineRunId, $.totalProcessed, $.totalAutoApproved, $.totalNeedingReview, $.proposedCheck.counts.vendors, $.proposedCheck.counts.zones, $.proposedCheck.counts.ratecodes, $$.Execution.Name)\"},\"ResultPath\":null,\"Next\":\"WaitForStewardApproval\"},\"WaitForStewardApproval\":{\"Type\":\"Wait\",\"Comment\":\"Wait 5 minutes before checking for approvals\",\"Seconds\":300,\"Next\":\"CheckApprovalStatus\"},\"CheckApprovalStatus\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Check if steward has approved any PROPOSED records\",\"Parameters\":{\"FunctionName\":\"mdm-check-approval\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\"}},\"ResultSelector\":{\"hasNewApprovals.$\":\"$.Payload.hasNewApprovals\",\"allProposedProcessed.$\":\"$.Payload.allProposedProcessed\",\"approvedRecords.$\":\"$.Payload.approvedRecords\",\"stats.$\":\"$.Payload.stats\"},\"ResultPath\":\"$.approvalStatus\",\"Next\":\"EvaluateApprovalStatus\"},\"EvaluateApprovalStatus\":{\"Type\":\"Choice\",\"Choices\":[{\"Variable\":\"$.approvalStatus.hasNewApprovals\",\"BooleanEquals\":true,\"Next\":\"EnrichApprovedTrips\"},{\"Variable\":\"$.approvalStatus.allProposedProcessed\",\"BooleanEquals\":true,\"Next\":\"PipelineSuccess\"}],\"Default\":\"WaitForStewardApproval\"},\"EnrichApprovedTrips\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Enrich trips that were waiting for the newly approved master data\",\"Parameters\":{\"FunctionName\":\"mdm-enrich-trip\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"approvedRecords.$\":\"$.approvalStatus.approvedRecords\"}},\"ResultSelector\":{\"tripsEnriched.$\":\"$.Payload.tripsEnriched\",\"stats.$\":\"$.Payload.stats\"},\"ResultPath\":\"$.enrichmentResult\",\"Next\":\"UpdateAuditAfterEnrichment\"},\"UpdateAuditAfterEnrichment\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Update audit with approval and enrichment statistics\",\"Parameters\":{\"FunctionName\":\"mdm-update-audit-history\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"eventType\":\"approval_update\",\"approvalStats.$\":\"$.approvalStatus.stats\",\"enrichmentStats.$\":\"$.enrichmentResult\"}},\"ResultPath\":\"$.auditResult\",\"Next\":\"CheckApprovalStatus\"},\"PipelineSuccess\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Mark pipeline as completed in audit table\",\"Parameters\":{\"FunctionName\":\"mdm-update-audit-history\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"eventType\":\"complete\",\"finalStats\":{\"totalTripsProcessed.$\":\"$.totalProcessed\",\"totalAutoApproved.$\":\"$.totalAutoApproved\",\"totalNeedingStewardReview.$\":\"$.totalNeedingReview\"}}},\"ResultSelector\":{\"pipelineRunId.$\":\"$.Payload.pipelineRunId\",\"status\":\"SUCCESS\",\"auditRecord.$\":\"$.Payload.auditRecord\"},\"End\":true},\"PipelineFailed\":{\"Type\":\"Task\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Comment\":\"Mark pipeline as failed in audit table\",\"Parameters\":{\"FunctionName\":\"mdm-update-audit-history\",\"Payload\":{\"pipelineRunId.$\":\"$.pipelineRunId\",\"eventType\":\"failed\",\"error.$\":\"States.Format('Pipeline execution failed - {}', $.error)\"}},\"ResultPath\":null,\"Next\":\"FailState\"},\"FailState\":{\"Type\":\"Fail\",\"Error\":\"PipelineExecutionError\",\"Cause\":\"Pipeline execution failed - check CloudWatch logs for details\"}}}",
    "roleArn": "arn:aws:iam::473157801752:role/service-role/StepFunctions-taxi-nyc-pipeline-role-ibi510h0v",
    "type": "STANDARD",
    "creationDate": "2026-01-17T05:18:08.005000+00:00",
    "loggingConfiguration": {
        "level": "OFF",
        "includeExecutionData": false
    },
    "tracingConfiguration": {
        "enabled": false
    },
    "revisionId": "d09f6490-28bb-4495-b8df-00087053ac52",
    "encryptionConfiguration": {
        "type": "AWS_OWNED_KEY"
    }
}
